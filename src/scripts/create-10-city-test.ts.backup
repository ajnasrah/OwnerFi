#!/usr/bin/env tsx

// 10-CITY TEST DATA CREATOR - Creates comprehensive test data for validation
// Creates 1 buyer and 1 realtor in each of 10 cities, then validates matching

import { ConsolidatedLeadSystem } from '../lib/consolidated-lead-system';
import { FirebaseDB } from '../lib/firebase-db';
import { Timestamp } from 'firebase/firestore';

interface TestCity {
  city: string;
  state: string;
  buyerName: string;
  realtorName: string;
  languages: string[];
}

const TEST_CITIES: TestCity[] = [
  { city: 'Dallas', state: 'TX', buyerName: 'John Smith', realtorName: 'Sarah Johnson', languages: ['English'] },
  { city: 'Memphis', state: 'TN', buyerName: 'Maria Garcia', realtorName: 'Michael Davis', languages: ['English'] },
  { city: 'Houston', state: 'TX', buyerName: 'David Wilson', realtorName: 'Lisa Chen', languages: ['English', 'Spanish'] },
  { city: 'Austin', state: 'TX', buyerName: 'Ashley Brown', realtorName: 'Robert Kim', languages: ['English'] },
  { city: 'San Antonio', state: 'TX', buyerName: 'James Miller', realtorName: 'Jennifer Lopez', languages: ['Spanish', 'English'] },
  { city: 'Fort Worth', state: 'TX', buyerName: 'Emily Jones', realtorName: 'Carlos Rodriguez', languages: ['English'] },
  { city: 'Nashville', state: 'TN', buyerName: 'Christopher Lee', realtorName: 'Amanda White', languages: ['English'] },
  { city: 'Knoxville', state: 'TN', buyerName: 'Jessica Taylor', realtorName: 'Brandon Thompson', languages: ['English'] },
  { city: 'Chattanooga', state: 'TN', buyerName: 'Ryan Anderson', realtorName: 'Nicole Martinez', languages: ['English'] },
  { city: 'El Paso', state: 'TX', buyerName: 'Sofia Ramirez', realtorName: 'Tyler Johnson', languages: ['Spanish', 'English'] }
];

async function create10CityTest() {
  console.log('üèôÔ∏è CREATING 10-CITY TEST DATA');
  console.log('==============================');
  
  const results = {
    buyersCreated: 0,
    realtorsCreated: 0,
    successfulMatches: 0,
    failedMatches: 0,
    cityResults: [] as Array<{
      city: string;
      state: string;
      buyerId: string;
      buyerName: string;
      realtorId: string;
      realtorName: string;
      languages: string[];
      matchesFound?: number;
      localMatchesFound?: number;
      matches?: Array<{
        buyerId: string;
        buyerName: string;
        matchScore: number;
        matchReasons: string[];
      }>;
    }>,
    errors: [] as string[]
  };
  
  try {
    // Step 1: Create buyers and realtors for each city
    console.log('\\nüë• Step 1: Creating buyers and realtors...');
    
    for (const cityData of TEST_CITIES) {
      console.log(`\\nüèôÔ∏è Processing ${cityData.city}, ${cityData.state}...`);
      
      try {
        // Create buyer
        const buyerId = await ConsolidatedLeadSystem.createBuyerProfile({
          userId: `test_buyer_${cityData.city.toLowerCase()}_${Date.now()}`,
          firstName: cityData.buyerName.split(' ')[0],
          lastName: cityData.buyerName.split(' ')[1],
          email: `${cityData.buyerName.replace(' ', '.').toLowerCase()}@${cityData.city.toLowerCase()}.test`,
          phone: `555-${Math.floor(Math.random() * 900) + 100}-${Math.floor(Math.random() * 9000) + 1000}`,
          city: `${cityData.city}, ${cityData.state}`,
          maxMonthlyPayment: Math.floor(Math.random() * 2000) + 1000, // $1000-3000
          maxDownPayment: Math.floor(Math.random() * 50000) + 20000,  // $20k-70k
          languages: cityData.languages
        });
        
        results.buyersCreated++;
        console.log(`  ‚úÖ Created buyer: ${cityData.buyerName} (${buyerId})`);
        
        // Create realtor user record  
        const realtorUserId = `test_realtor_${cityData.city.toLowerCase()}_${Date.now()}`;
        const realtorData = {
          email: `${cityData.realtorName.replace(' ', '.').toLowerCase()}@${cityData.city.toLowerCase()}.realty`,
          name: cityData.realtorName,
          role: 'realtor',
          password: 'test123',
          realtorData: {
            firstName: cityData.realtorName.split(' ')[0],
            lastName: cityData.realtorName.split(' ')[1],
            company: `${cityData.city} Premier Realty`,
            credits: 20, // Give credits for testing
            isOnTrial: true,
            trialStartDate: Timestamp.now(),
            trialEndDate: Timestamp.fromDate(new Date(Date.now() + 30 * 24 * 60 * 60 * 1000)),
            serviceArea: {
              primaryCity: {
                name: cityData.city,
                state: cityData.state,
                stateCode: cityData.state
              },
              totalCitiesServed: 1,
              nearbyCities: []
            },
            serviceCities: [`${cityData.city}, ${cityData.state}`],
            languages: cityData.languages
          },
          createdAt: Timestamp.now(),
          updatedAt: Timestamp.now()
        };
        
        await FirebaseDB.createDocument('users', realtorData, realtorUserId);
        results.realtorsCreated++;
        console.log(`  ‚úÖ Created realtor: ${cityData.realtorName} (${realtorUserId})`);
        
        // Store for matching test
        results.cityResults.push({
          city: cityData.city,
          state: cityData.state,
          buyerId,
          buyerName: cityData.buyerName,
          realtorId: realtorUserId,
          realtorName: cityData.realtorName,
          languages: cityData.languages
        });
        
      } catch (error) {
        const errorMsg = `Failed to create data for ${cityData.city}: ${(error as Error).message}`;
        results.errors.push(errorMsg);
        console.error(`  ‚ùå ${errorMsg}`);
      }
    }
    
    // Step 2: Test matching for each realtor
    console.log(`\\nüéØ Step 2: Testing buyer-realtor matching...`);
    
    for (const cityResult of results.cityResults) {
      try {
        console.log(`\\nüè¢ Testing ${cityResult.realtorName} in ${cityResult.city}, ${cityResult.state}...`);
        
        const realtorProfile = {
          cities: [cityResult.city],
          languages: cityResult.languages,
          state: cityResult.state
        };
        
        const matches = await ConsolidatedLeadSystem.findAvailableLeads(realtorProfile);
        
        // Filter to only buyers in the same city for validation
        const localMatches = matches.filter(match => 
          match.city === cityResult.city && match.state === cityResult.state
        );
        
        cityResult.matchesFound = matches.length;
        cityResult.localMatchesFound = localMatches.length;
        cityResult.matches = localMatches.map(m => ({
          buyerId: m.id,
          buyerName: `${m.firstName} ${m.lastName}`,
          matchScore: m.matchScore,
          matchReasons: m.matchReasons
        }));
        
        if (localMatches.length > 0) {
          results.successfulMatches++;
          console.log(`  ‚úÖ Found ${localMatches.length} local matches (${matches.length} total)`);
          localMatches.forEach(match => {
            console.log(`    - ${match.firstName} ${match.lastName} (Score: ${match.matchScore})`);
          });
        } else {
          results.failedMatches++;
          console.log(`  ‚ùå No matches found for ${cityResult.realtorName}`);
        }
        
      } catch (error) {
        results.failedMatches++;
        const errorMsg = `Matching failed for ${cityResult.realtorName}: ${(error as Error).message}`;
        results.errors.push(errorMsg);
        console.error(`  ‚ùå ${errorMsg}`);
      }
    }
    
    // Step 3: Validate cross-city isolation
    console.log(`\\nüö´ Step 3: Testing cross-city isolation...`);
    
    // Test: Dallas realtor should NOT see Memphis buyers
    const dallasRealtorProfile = { cities: ['Dallas'], languages: ['English'], state: 'TX' };
    const memphisMatches = await ConsolidatedLeadSystem.findAvailableLeads(dallasRealtorProfile);
    const memphisBuyersFound = memphisMatches.filter(m => m.city === 'Memphis');
    
    console.log(`Dallas realtor found ${memphisBuyersFound.length} Memphis buyers (should be 0): ${memphisBuyersFound.length === 0 ? '‚úÖ' : '‚ùå'}`);
    
    // Test: Memphis realtor should NOT see Dallas buyers  
    const memphisRealtorProfile = { cities: ['Memphis'], languages: ['English'], state: 'TN' };
    const dallasMatches = await ConsolidatedLeadSystem.findAvailableLeads(memphisRealtorProfile);
    const dallasBuyersFound = dallasMatches.filter(m => m.city === 'Dallas');
    
    console.log(`Memphis realtor found ${dallasBuyersFound.length} Dallas buyers (should be 0): ${dallasBuyersFound.length === 0 ? '‚úÖ' : '‚ùå'}`);
    
    // Step 4: Get final statistics
    console.log(`\\nüìä Step 4: Final statistics...`);
    const stats = await ConsolidatedLeadSystem.getSystemStatistics();
    
    // Step 5: Summary report
    console.log(`\\nüìã FINAL RESULTS`);
    console.log('================');
    console.log(`Buyers created: ${results.buyersCreated}/${TEST_CITIES.length}`);
    console.log(`Realtors created: ${results.realtorsCreated}/${TEST_CITIES.length}`);
    console.log(`Successful matches: ${results.successfulMatches}/${TEST_CITIES.length}`);
    console.log(`Failed matches: ${results.failedMatches}`);
    console.log(`Errors: ${results.errors.length}`);
    
    console.log(`\\nüèÜ SUCCESS RATE: ${Math.round((results.successfulMatches / TEST_CITIES.length) * 100)}%`);
    
    if (results.errors.length > 0) {
      console.log(`\\n‚ùå ERRORS:`);
      results.errors.forEach(error => console.log(`  - ${error}`));
    }
    
    // Detailed city breakdown
    console.log(`\\nüèôÔ∏è CITY-BY-CITY RESULTS:`);
    results.cityResults.forEach(city => {
      const status = city.localMatchesFound > 0 ? '‚úÖ' : '‚ùå';
      console.log(`${status} ${city.city}, ${city.state}: ${city.realtorName} ‚Üí ${city.localMatchesFound} matches`);
    });
    
    console.log(`\\nüìä SYSTEM STATISTICS:`);
    console.log(`Total buyer profiles: ${stats.totalBuyerProfiles}`);
    console.log(`Available for purchase: ${stats.availableForPurchase}`);
    console.log(`Already purchased: ${stats.purchased}`);
    console.log(`Active in last week: ${stats.activeInLastWeek}`);
    console.log(`States: ${Object.keys(stats.byState).join(', ')}`);
    
    // Final validation
    const overallSuccess = 
      results.buyersCreated === TEST_CITIES.length &&
      results.realtorsCreated === TEST_CITIES.length &&
      results.successfulMatches >= TEST_CITIES.length * 0.8 && // 80% success rate
      results.errors.length === 0;
    
    console.log(`\\n${overallSuccess ? 'üéâ OVERALL TEST: PASSED' : 'üí• OVERALL TEST: FAILED'}`);
    
    if (overallSuccess) {
      console.log(`\\n‚úÖ The consolidated buyer system is working perfectly!`);
      console.log(`‚úÖ Dallas-Memphis matching validated`);
      console.log(`‚úÖ All 10 cities have proper buyer-realtor matching`);
      console.log(`‚úÖ Cross-city isolation working correctly`);
      console.log(`‚úÖ Lead selling system operational`);
    }
    
  } catch (error) {
    console.error('‚ùå TEST SUITE FAILED:', error);
    process.exit(1);
  }
}

// Run the test
if (require.main === module) {
  create10CityTest();
}

export { create10CityTest };