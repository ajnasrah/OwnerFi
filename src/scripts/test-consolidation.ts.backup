#!/usr/bin/env tsx

// CONSOLIDATION TEST SCRIPT - Test the buyer system consolidation locally
// This script validates all components without needing a running server

import { ConsolidatedLeadSystem } from '../lib/consolidated-lead-system';
import { BuyerSystemMigration } from '../lib/buyer-system-migration';

async function testConsolidation() {
  console.log('🧪 TESTING BUYER SYSTEM CONSOLIDATION');
  console.log('=====================================');
  
  try {
    // Test 1: Consolidated Lead System Statistics
    console.log('\n📊 Test 1: Getting system statistics...');
    const stats = await ConsolidatedLeadSystem.getSystemStatistics();
    console.log('Statistics:', JSON.stringify(stats, null, 2));
    
    // Test 2: Create Dallas buyer
    console.log('\n👤 Test 2: Creating Dallas buyer...');
    const dallasBuyerId = await ConsolidatedLeadSystem.createBuyerProfile({
      userId: `test_dallas_buyer_${Date.now()}`,
      firstName: 'John',
      lastName: 'Smith',
      email: 'john.smith.dallas@test.com',
      phone: '555-123-4567',
      city: 'Dallas, TX',
      maxMonthlyPayment: 2000,
      maxDownPayment: 50000,
      languages: ['English']
    });
    console.log(`✅ Created Dallas buyer: ${dallasBuyerId}`);
    
    // Test 3: Create Memphis buyer
    console.log('\n👤 Test 3: Creating Memphis buyer...');
    const memphisBuyerId = await ConsolidatedLeadSystem.createBuyerProfile({
      userId: `test_memphis_buyer_${Date.now()}`,
      firstName: 'Maria',
      lastName: 'Garcia',
      email: 'maria.garcia.memphis@test.com',
      phone: '555-987-6543',
      city: 'Memphis, TN',
      maxMonthlyPayment: 1800,
      maxDownPayment: 40000,
      languages: ['English']
    });
    console.log(`✅ Created Memphis buyer: ${memphisBuyerId}`);
    
    // Test 4: Test Dallas realtor matching
    console.log('\n🏢 Test 4: Testing Dallas realtor matching...');
    const dallasMatches = await ConsolidatedLeadSystem.findAvailableLeads({
      cities: ['Dallas'],
      languages: ['English'],
      state: 'TX'
    });
    console.log(`✅ Dallas realtor found ${dallasMatches.length} matches:`, 
      dallasMatches.map(m => `${m.firstName} ${m.lastName} (${m.city}, ${m.state}) - Score: ${m.matchScore}`));
    
    // Test 5: Test Memphis realtor matching  
    console.log('\n🏢 Test 5: Testing Memphis realtor matching...');
    const memphisMatches = await ConsolidatedLeadSystem.findAvailableLeads({
      cities: ['Memphis'],
      languages: ['English'],
      state: 'TN'
    });
    console.log(`✅ Memphis realtor found ${memphisMatches.length} matches:`,
      memphisMatches.map(m => `${m.firstName} ${m.lastName} (${m.city}, ${m.state}) - Score: ${m.matchScore}`));
    
    // Test 6: Cross-state matching (should fail)
    console.log('\n❌ Test 6: Testing cross-state matching (should find 0)...');
    const crossStateMatches = await ConsolidatedLeadSystem.findAvailableLeads({
      cities: ['Dallas'], 
      languages: ['English'],
      state: 'TN' // TN realtor looking for Dallas buyers (should fail)
    });
    console.log(`✅ Cross-state test: ${crossStateMatches.length} matches (expected: 0)`);
    
    // Test 7: Purchase a lead
    console.log('\n💳 Test 7: Testing lead purchase...');
    if (dallasMatches.length > 0) {
      const purchaseResult = await ConsolidatedLeadSystem.purchaseLead(
        dallasMatches[0].id,
        'test_realtor_123'
      );
      console.log('Purchase result:', purchaseResult);
      
      // Verify buyer is no longer available
      const postPurchaseMatches = await ConsolidatedLeadSystem.findAvailableLeads({
        cities: ['Dallas'],
        languages: ['English'],
        state: 'TX'
      });
      console.log(`✅ After purchase: ${postPurchaseMatches.length} matches (should be 1 less)`);
    }
    
    // Test 8: Final statistics
    console.log('\n📊 Test 8: Final statistics...');
    const finalStats = await ConsolidatedLeadSystem.getSystemStatistics();
    console.log('Final statistics:', JSON.stringify(finalStats, null, 2));
    
    console.log('\n✅ ALL TESTS COMPLETED SUCCESSFULLY!');
    console.log('\n🎯 VALIDATION RESULTS:');
    console.log(`- Dallas buyer created: ${dallasBuyerId ? '✅' : '❌'}`);
    console.log(`- Memphis buyer created: ${memphisBuyerId ? '✅' : '❌'}`);
    console.log(`- Dallas realtor matching: ${dallasMatches.length > 0 ? '✅' : '❌'} (${dallasMatches.length} matches)`);
    console.log(`- Memphis realtor matching: ${memphisMatches.length > 0 ? '✅' : '❌'} (${memphisMatches.length} matches)`);
    console.log(`- Cross-state isolation: ${crossStateMatches.length === 0 ? '✅' : '❌'} (${crossStateMatches.length} matches)`);
    
  } catch (error) {
    console.error('❌ TEST FAILED:', error);
    process.exit(1);
  }
}

// Run the test
if (require.main === module) {
  testConsolidation();
}